<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesmen Uji Pengetahuan PBO: Enkapsulasi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Instances (global within this module script)
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Inisialisasi Firebase
        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Autentikasi
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }
                isAuthReady = true;
                console.log("Firebase initialized and user authenticated:", userId);
                
                // Setelah autentikasi berhasil, render UI
                renderApp();
                setupHistoryListener();
            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                isAuthReady = true;
                renderApp(); // Render even if auth failed, but functionality might be limited
            }
        };

        // --- DATA SOAL ASESMEN ---
        const QUESTIONS = [
            { q: "Tujuan utama enkapsulasi dalam PBO adalah…", options: ["Membuat class menjadi lebih cepat dieksekusi", "Menyembunyikan data agar tidak diakses langsung dari luar class", "Menghapus variabel yang tidak digunakan", "Mengubah tipe data variabel", "Menggabungkan dua class menjadi satu"], answerIndex: 1 },
            { q: "Kata kunci yang digunakan untuk menyembunyikan atribut dalam class adalah…", options: ["public", "static", "void", "private", "protected"], answerIndex: 3 },
            { q: "Atribut yang dienkapsulasi pada class AkunBank adalah…", options: ["saldo, pin, bunga", "namaPemilik, nomorAkun, saldo", "alamat, saldo, password", "namaBank, cabang, nomorAkun", "nomorAkun, pin, bunga"], answerIndex: 1 },
            { q: "Metode yang digunakan untuk mengambil nilai dari atribut private adalah…", options: ["Setter", "Getter", "Konstruktor", "Scanner", "Static method"], answerIndex: 1 },
            { q: "Fungsi setter adalah…", options: ["Menghapus objek", "Mengatur nilai atribut private", "Membuat objek baru", "Menjalankan method main", "Mengembalikan nilai saldo"], answerIndex: 1 },
            { q: "Keyword 'this' digunakan untuk…", options: ["Menghapus variabel", "Mengacu pada objek saat ini", "Membuat objek baru", "Mengubah tipe data", "Mengisi nilai default"], answerIndex: 1 },
            { q: "Pernyataan yang benar tentang konstruktor adalah…", options: ["Konstruktor boleh diberi tipe kembalian", "Nama konstruktor harus sama dengan nama class", "Konstruktor harus static", "Konstruktor hanya boleh satu", "Konstruktor harus selalu kosong"], answerIndex: 1 },
            { q: "Konstruktor AkunBank digunakan untuk…", options: ["Menginisialisasi namaPemilik dan nomorAkun", "Mengubah saldo", "Menghapus data akun", "Menjalankan setter", "Menampilkan saldo"], answerIndex: 0 },
            { q: "Ketika saldo dibiarkan public, risikonya adalah…", options: ["Nilai saldo otomatis menjadi nol", "Saldo bisa diubah sembarang dari luar class", "Getter tidak bisa dipakai", "Konstruktor tidak bisa dipanggil", "Error kompilasi"], answerIndex: 1 },
            { q: "Pada metode deposit, aturan validasi yang benar adalah…", options: ["jumlah harus negatif", "jumlah boleh nol", "jumlah harus > 0", "jumlah harus kelipatan 1000", "jumlah bebas tanpa syarat"], answerIndex: 2 },
            { q: "Pada penarikan, transaksi gagal jika…", options: ["jumlah = saldo", "jumlah < saldo", "jumlah > saldo", "jumlah = 0", "saldo = 0"], answerIndex: 2 },
            { q: "Tipe data yang tepat untuk saldo akun bank adalah…", options: ["int", "float", "byte", "double", "String"], answerIndex: 3 },
            { q: "Pernyataan deposit berikut yang benar adalah…", options: ["saldo = saldo – jumlah", "saldo = saldo + jumlah", "jumlah = jumlah + saldo", "saldo = jumlah", "jumlah = saldo"], answerIndex: 1 },
            { q: "Fungsi method cetakInfoAkun() adalah…", options: ["Mengambil nilai saldo", "Mencetak informasi lengkap akun", "Mengubah nomor akun", "Menghapus objek akun", "Membuat objek baru"], answerIndex: 1 },
            { q: "Jika baris akun1.saldo dicoba diakses dari main, maka…", options: ["Berhasil tanpa error", "Hanya berjalan jika saldo static", "Akan muncul error kompilasi", "Akan menampilkan saldo default", "Menghasilkan output kosong"], answerIndex: 2 },
            { q: "Error terjadi jika setter ditulis seperti ini: public setSaldo(double s) { saldo = s; }. Kesalahannya adalah…", options: ["Harus static", "Harus memiliki tipe kembalian void", "Parameter salah", "Nama method salah", "Tipe data harus int"], answerIndex: 1 },
            { q: "Getter yang benar untuk atribut namaPemilik adalah…", options: ["public void getNamaPemilik()", "public String namaPemilik()", "public String getNamaPemilik()", "String getNamaPemilik(String n)", "private String getNamaPemilik()"], answerIndex: 2 },
            { q: "Jika konstruktor tidak diberi parameter tetapi atribut harus diisi, maka…", options: ["Nilai tidak bisa diakses", "Nilai harus diisi lewat setter", "Program tidak bisa dijalankan", "Getter tidak berguna", "Harus membuat dua konstruktor"], answerIndex: 1 },
            { q: "Tujuan validasi penarikan adalah…", options: ["Mengizinkan saldo negatif", "Mencegah saldo minus", "Menghapus saldo lama", "Menggandakan saldo", "Mengubah nomor rekening"], answerIndex: 1 },
            { q: "Kode berikut termasuk… private String nomorAkun;", options: ["Deklarasi variabel public", "Deklarasi getter", "Enkapsulasi atribut", "Pembuatan konstruktor", "Method setter"], answerIndex: 2 },
            // DEBUGGING & PEMAHAMAN KODE
            { q: "public AkunBank(String nama, String no) { namaPemilik = nama; }. Kesalahannya adalah…", options: ["Konstruktor tidak boleh memakai parameter", "nomorAkun tidak diinisialisasi", "namaPemilik harus public", "Tipe data salah", "Harus menggunakan this"], answerIndex: 1 },
            { q: "public String getSaldo() { return saldo; }. Kesalahannya…", options: ["Getter harus void", "return harus double, bukan String", "saldo harus public", "saldo harus String", "Getter harus static"], answerIndex: 1 },
            { q: "public void setNamaPemilik() { this.namaPemilik = namaPemilik; }. Kesalahannya adalah…", options: ["Tidak ada parameter untuk menerima nilai baru", "Setter harus int", "Setter harus mengembalikan sesuatu", "Tidak boleh menggunakan this", "Getter harus dibuat dulu"], answerIndex: 0 },
            { q: "public boolean deposit(double jumlah) { saldo += jumlah; return true; }. Masalahnya adalah…", options: ["saldo harus dikurangi", "Tidak ada validasi jumlah > 0", "Harus bertipe void", "Parameter salah", "deposit harus static"], answerIndex: 1 },
            { q: "public boolean penarikan(double jumlah) { if (jumlah < saldo) return false; saldo -= jumlah; return true; }. Kesalahan logika adalah…", options: ["Harus return false jika saldo cukup", "Penarikan harus menambah saldo", "Syarat < seharusnya >", "Parameter harus int", "Konstruktor harus dibuat dulu"], answerIndex: 2 },
            // MULAI RESET CHECKPOINT (Soal ke-25)
            { q: "Tujuan method cetakHasilTransaksi() adalah…", options: ["Menjalankan deposit", "Menjalankan penarikan", "Menampilkan hasil transaksi di konsol", "Mengubah saldo", "Menjalankan setter"], answerIndex: 2 },
            { q: "Jika kode berikut dijalankan: AkunBank a = new AkunBank('Budi', '001'); System.out.println(a.getNamaPemilik());. Maka output adalah…", options: ["Error", "null", "“Budi”", "0", "Tidak muncul apa-apa"], answerIndex: 2 },
            { q: "Mengapa saldo tidak boleh diakses langsung dari main?", options: ["Karena saldo harus static", "Karena saldo wajib publik", "Karena saldo dienkapsulasi (private)", "Karena saldo tidak bertipe String", "Karena setter belum dibuat"], answerIndex: 2 },
            { q: "Jika deposit dilakukan dengan jumlah = -1000, maka…", options: ["Saldo berkurang", "Saldo menjadi negatif", "Deposit gagal (false)", "Deposit berhasil", "Program error"], answerIndex: 2 },
            { q: "Method penarikan benar jika…", options: ["jumlah > 0 dan jumlah ≤ saldo", "jumlah boleh 0", "jumlah bebas", "jumlah selalu ditolak", "jumlah selalu diterima"], answerIndex: 0 },
            // Lanjutan Soal
            { q: "Jika saldo awal 100.000 lalu deposit 50.000, maka saldo menjadi…", options: ["100.000", "50.000", "150.000", "200.000", "0"], answerIndex: 2 },
            { q: "Jika saldo 20.000 dan ingin menarik 50.000 maka…", options: ["Berhasil", "Saldo menjadi negatif", "Gagal (jumlah melebihi saldo)", "Program berhenti", "Saldo jadi nol"], answerIndex: 2 },
            { q: "Perintah untuk membuat objek baru AkunBank adalah…", options: ["AkunBank();", "new AkunBank;", "AkunBank a = new AkunBank('A', '01');", "AkunBank a();", "create AkunBank;"], answerIndex: 2 },
            { q: "Data yang cocok disimpan dalam nomorAkun adalah…", options: ["Nama lengkap", "Tanggal lahir", "String identifikasi rekening", "Saldo terakhir", "Boolean status"], answerIndex: 2 },
            { q: "PBO mengajarkan bahwa enkapsulasi penting karena…", options: ["Mempercepat komputasi", "Membuat variabel menjadi global", "Mencegah akses sembarang dari luar class", "Menghilangkan error otomatis", "Mengubah tipe data otomatis"], answerIndex: 2 },
            { q: "Jika getter salah ketik: return salddo;. Maka akan terjadi…", options: ["Saldo ditambah otomatis", "Program tetap berjalan", "Error variabel tidak dikenal", "Hasil output 0", "Hasil output kosong"], answerIndex: 2 },
            { q: "Yang termasuk logika bisnis bank adalah…", options: ["saldo harus nol", "saldo boleh negatif", "penarikan tidak boleh melebihi saldo", "deposit bebas angka minus", "semua transaksi otomatis disetujui"], answerIndex: 2 },
            { q: "Class AkunBankApp bertujuan untuk…", options: ["Menyimpan saldo", "Memvalidasi konstruktor", "Mengelola output hasil transaksi", "Membuat objek", "Memperbaiki bug konstruktor"], answerIndex: 2 },
            { q: "Class Main berfungsi sebagai…", options: ["Tempat menyimpan atribut", "Tempat eksekusi program", "Penyimpan saldo utama", "Pengganti setter", "Penggabung class"], answerIndex: 1 },
            { q: "Mengapa wajib melakukan 'Uji Data Hiding'?", options: ["Untuk memastikan setter bekerja", "Untuk memastikan saldo tidak bisa diakses langsung", "Untuk menambah fitur baru", "Untuk membuat saldo menjadi public", "Untuk menghapus konstruktor"], answerIndex: 1 },
        ];

        const TIME_PER_QUESTION = 20; // Waktu dalam detik
        const RESET_CHECKPOINT_Q = 25; // Soal ke-25
        const MIN_CORRECT_TO_PASS = 20; // Minimum jawaban benar untuk melanjutkan setelah Q25

        // --- STATE MANAJEMEN (In-Memory) ---
        // *Semua state ini akan hilang saat tab ditutup/reload, sesuai permintaan pengguna.*
        let quizState = {
            isLoggedIn: false,
            currentQuestion: 0,
            score: 0,
            answers: Array(QUESTIONS.length).fill(null),
            timeRemaining: TIME_PER_QUESTION,
            isFinished: false,
            showModal: false,
            modalMessage: '',
            modalType: '',
        };
        let user = { name: '', nis: '' };
        let timerInterval = null;

        // --- DOM ELEMENTS & RENDER FUNCTIONS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const renderQuiz = () => {
            const container = $('#quiz-container');
            if (!container) return;

            if (quizState.isFinished) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-6 bg-white shadow-xl rounded-xl w-full max-w-md">
                        <h2 class="text-2xl font-extrabold text-indigo-700 mb-6 border-b-2 pb-2">Asesmen Selesai</h2>
                        <p class="text-gray-700 mb-6 text-center">Selamat ${user.name}, Anda telah menyelesaikan asesmen.</p>
                        <button onclick="resetQuiz()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md">
                            Kembali ke Login
                        </button>
                    </div>
                `;
                return;
            }

            if (!quizState.isLoggedIn) {
                container.innerHTML = renderLoginHTML();
                $('#login-form').addEventListener('submit', handleLogin);
                return;
            }

            const qIndex = quizState.currentQuestion;
            const currentQData = QUESTIONS[qIndex];
            const isCheckpointQuestion = qIndex === RESET_CHECKPOINT_Q - 1;

            let optionsHTML = currentQData.options.map((option, index) => `
                <button
                    onclick="handleAnswer(${index})"
                    class="w-full text-left p-4 border border-gray-200 rounded-lg bg-gray-50 hover:bg-indigo-100 transition duration-200 text-gray-700 font-medium shadow-sm"
                >
                    <span class="font-bold mr-3 text-indigo-600">${String.fromCharCode(65 + index)}.</span>
                    ${option}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="flex flex-col p-6 bg-white shadow-xl rounded-xl w-full max-w-2xl min-h-[400px]">
                    <!-- Header Kuis & Timer -->
                    <div class="flex justify-between items-center mb-4 pb-2 border-b">
                        <div class="text-lg font-semibold text-gray-700">Soal ${qIndex + 1} dari ${QUESTIONS.length}</div>
                        <div id="timer" class="text-2xl font-extrabold px-4 py-1 rounded-full shadow-lg bg-indigo-500 text-white">
                            ${quizState.timeRemaining}s
                        </div>
                    </div>

                    <!-- Status Siswa -->
                    <div class="text-sm mb-4 text-gray-500">
                        <p>Nama: <span class="font-medium text-gray-800">${user.name}</span> | NIS: <span class="font-medium text-gray-800">${user.nis}</span></p>
                        ${isCheckpointQuestion ? `
                            <p class="text-sm font-bold text-red-600 mt-2">
                                PERHATIAN: Checkpoint Reset diaktifkan pada soal ke-25. Wajib benar ${MIN_CORRECT_TO_PASS} soal untuk lanjut!
                            </p>
                        ` : ''}
                    </div>

                    <!-- Pertanyaan -->
                    <div class="text-xl font-medium mb-6 text-gray-800">
                        ${currentQData.q}
                    </div>

                    <!-- Pilihan Jawaban -->
                    <div class="space-y-3">
                        ${optionsHTML}
                    </div>
                </div>
            `;
            updateTimerDisplay();
        };

        const renderLoginHTML = () => `
            <div class="flex flex-col items-center justify-center p-6 bg-white shadow-xl rounded-xl w-full max-w-md">
                <h2 class="text-2xl font-extrabold text-indigo-700 mb-6 border-b-2 pb-2">Aplikasi Asesmen Enkapsulasi</h2>
                <p class="text-red-500 text-center mb-4 font-semibold">
                    * PERINGATAN: Jika Anda me-reload halaman atau pindah tab, sesi asesmen akan direset dan harus mengulang dari login.
                </p>
                <form id="login-form" class="w-full space-y-4">
                    <input
                        type="text"
                        placeholder="Nama Lengkap"
                        name="name"
                        value="${user.name}"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        required
                    />
                    <input
                        type="text"
                        placeholder="NIS (Nomor Induk Siswa)"
                        name="nis"
                        value="${user.nis}"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                        required
                    />
                    <button
                        type="submit"
                        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md"
                    >
                        Mulai Asesmen
                    </button>
                </form>
                <p class="mt-4 text-sm text-gray-500">Total Soal: ${QUESTIONS.length} | Waktu per soal: ${TIME_PER_QUESTION} detik</p>
            </div>
        `;

        const renderHistory = (history) => {
            const historyContainer = $('#history-container');
            if (!historyContainer) return;

            let historyListHTML = '';
            if (history.length > 0) {
                historyListHTML = history.map(item => `
                    <div class="p-3 bg-gray-50 rounded-lg shadow-sm border-l-4 border-indigo-400">
                        <p class="font-bold text-gray-800">Nama: ${item.name} | NIS: ${item.nis}</p>
                        <p class="text-sm text-gray-600">
                            Skor Akhir: <span class="font-extrabold text-lg ${item.totalScore >= 75 ? 'text-green-700' : 'text-red-700'}">${item.totalScore}%</span> 
                            (${item.totalCorrect} benar dari ${item.totalQuestions} soal)
                        </p>
                        <p class="text-xs text-gray-500">Waktu: ${item.timestamp}</p>
                    </div>
                `).join('');
            } else {
                historyListHTML = `<p class="text-gray-500">Belum ada riwayat asesmen yang tersimpan.</p>`;
            }

            historyContainer.innerHTML = `
                <div class="mt-8 p-6 bg-white shadow-xl rounded-xl w-full max-w-2xl">
                    <h2 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Riwayat Asesmen (10 Hasil Terbaru)</h2>
                    <div class="space-y-3">${historyListHTML}</div>
                </div>
            `;
        };

        const renderModal = () => {
            const modalContainer = $('#modal-container');
            if (!modalContainer) return;

            if (quizState.showModal) {
                const isFail = quizState.modalType === 'fail';
                modalContainer.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-md transform transition-all duration-300 ${isFail ? 'border-4 border-red-500' : 'border-4 border-green-500'}">
                            <h3 class="text-2xl font-bold mb-3">${isFail ? 'ASESSMEN DIRESET!' : 'SELESAI!'}</h3>
                            <p class="text-gray-700 mb-6">${quizState.modalMessage}</p>
                            <button
                                onclick="handleModalClose()"
                                class="w-full py-3 rounded-lg font-semibold text-white transition duration-200 ${isFail ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}"
                            >
                                ${isFail ? 'Kembali ke Login' : 'Lihat Hasil Akhir'}
                            </button>
                        </div>
                    </div>
                `;
            } else {
                modalContainer.innerHTML = '';
            }
        };

        // --- FIREBASE LISTENERS ---
        const setupHistoryListener = () => {
            if (!db || !userId) return;
            const historyCollection = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_history');
            const q = query(historyCollection, orderBy('timestamp', 'desc'), limit(10));

            onSnapshot(q, (snapshot) => {
                const fetchedHistory = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()).toLocaleString() : 'N/A'
                }));
                renderHistory(fetchedHistory);
            }, (error) => {
                console.error("Error fetching quiz history: ", error);
            });
        };

        // --- TIMER & CHECKPOINT LOGIC ---
        const startTimer = () => {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                quizState.timeRemaining--;
                updateTimerDisplay();

                if (quizState.timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        };

        const updateTimerDisplay = () => {
            const timerElement = $('#timer');
            if (timerElement) {
                timerElement.textContent = `${quizState.timeRemaining}s`;
                if (quizState.timeRemaining <= 5) {
                    timerElement.className = 'text-2xl font-extrabold px-4 py-1 rounded-full shadow-lg bg-red-500 text-white animate-pulse';
                } else {
                    timerElement.className = 'text-2xl font-extrabold px-4 py-1 rounded-full shadow-lg bg-indigo-500 text-white';
                }
            }
        };

        const handleTimeout = () => {
            // Pindah ke soal berikutnya setelah timer habis
            if (quizState.currentQuestion < QUESTIONS.length - 1) {
                quizState.currentQuestion++;
                quizState.timeRemaining = TIME_PER_QUESTION;
                checkCheckpoint();
                renderQuiz();
                startTimer();
            } else {
                // Jika soal terakhir, selesaikan kuis
                finishQuiz('success', `Selamat ${user.name}, Anda telah menyelesaikan asesmen. Skor total Anda akan segera diproses.`);
            }
        };

        const checkCheckpoint = () => {
            // Cek dilakukan saat akan pindah ke soal baru (setelah menjawab soal sebelumnya)
            if (quizState.currentQuestion === RESET_CHECKPOINT_Q) {
                // Hitung skor dari soal 1 sampai 24 (index 0 sampai 23)
                const correctCountUntilCheckpoint = quizState.answers.slice(0, RESET_CHECKPOINT_Q - 1).reduce((acc, selected, index) => {
                    return acc + (selected === QUESTIONS[index].answerIndex ? 1 : 0);
                }, 0);

                if (correctCountUntilCheckpoint < MIN_CORRECT_TO_PASS) {
                    // Trigger reset!
                    finishQuiz('fail', `Skor benar saat ini (${correctCountUntilCheckpoint}) kurang dari batas minimum (${MIN_CORRECT_TO_PASS}) pada soal ke-${RESET_CHECKPOINT_Q - 1}. Asesmen direset dan akan mengulang dari awal.`);
                }
            }
        };

        const finishQuiz = (type, message) => {
            clearInterval(timerInterval);
            quizState.isFinished = true;
            quizState.showModal = true;
            quizState.modalType = type;
            quizState.modalMessage = message;
            
            if (type === 'success') {
                const finalCorrect = quizState.answers.reduce((acc, selected, index) => {
                    return acc + (selected === QUESTIONS[index].answerIndex ? 1 : 0);
                }, 0);
                const finalScore = (finalCorrect / QUESTIONS.length) * 100;
                submitResult(finalScore, finalCorrect);
            }
            renderModal();
            renderQuiz(); // Render tampilan selesai
        };

        // --- HANDLERS ---
        window.resetQuiz = () => {
            clearInterval(timerInterval);
            // Reset semua state in-memory
            quizState = {
                isLoggedIn: false,
                currentQuestion: 0,
                score: 0,
                answers: Array(QUESTIONS.length).fill(null),
                timeRemaining: TIME_PER_QUESTION,
                isFinished: false,
                showModal: false,
                modalMessage: '',
                modalType: '',
            };
            user = { name: '', nis: '' };
            renderApp();
        };

        const handleLogin = (e) => {
            e.preventDefault();
            const nameInput = e.target.elements.name.value.trim();
            const nisInput = e.target.elements.nis.value.trim();

            if (nameInput && nisInput) {
                user.name = nameInput;
                user.nis = nisInput;
                quizState.isLoggedIn = true;
                quizState.currentQuestion = 0;
                quizState.score = 0;
                quizState.answers = Array(QUESTIONS.length).fill(null);
                quizState.timeRemaining = TIME_PER_QUESTION;
                quizState.isFinished = false;

                renderQuiz();
                startTimer();
            }
        };
        window.handleLogin = handleLogin; // Expose to global scope for event listener

        window.handleAnswer = (selectedIndex) => {
            const currentQ = quizState.currentQuestion;
            const isCorrect = selectedIndex === QUESTIONS[currentQ].answerIndex;

            // Catat Jawaban
            quizState.answers[currentQ] = selectedIndex;

            // Hitung skor (hanya soal ini)
            quizState.score += (isCorrect ? 1 : 0);
            
            // Pindah ke soal berikutnya
            if (currentQ < QUESTIONS.length - 1) {
                quizState.currentQuestion++;
                quizState.timeRemaining = TIME_PER_QUESTION; // Reset timer
                
                checkCheckpoint();
                renderQuiz();
                startTimer();
            } else {
                // Selesaikan Kuis
                finishQuiz('success', `Selamat ${user.name}, Anda telah menyelesaikan asesmen. Skor total Anda akan segera diproses.`);
            }
        };

        window.handleModalClose = () => {
            quizState.showModal = false;
            renderModal();
            
            // Jika reset (gagal checkpoint atau selesai sukses), kembali ke login
            if (quizState.modalType === 'fail' || quizState.modalType === 'success') {
                resetQuiz();
            }
        };

        const submitResult = async (finalScore, finalCorrect) => {
            if (!db || !userId || !user.name || !user.nis) return; 

            const resultData = {
                userId: userId, 
                name: user.name,
                nis: user.nis,
                totalScore: finalScore.toFixed(2),
                totalCorrect: finalCorrect,
                totalQuestions: QUESTIONS.length,
                timestamp: serverTimestamp(),
            };

            try {
                const historyCollection = collection(db, 'artifacts', appId, 'public', 'data', 'quiz_history');
                await addDoc(historyCollection, resultData);
                console.log("Result saved successfully!");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        // Main render loop
        const renderApp = () => {
            if (!isAuthReady) {
                $('#app-root').innerHTML = '<div class="text-lg font-semibold text-gray-600">Memuat layanan Firebase...</div>';
            } else {
                renderQuiz();
                renderModal();
            }
        };

        // Inisialisasi saat dokumen siap
        document.addEventListener('DOMContentLoaded', initializeFirebase);

    </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Asesmen Uji Pengetahuan PBO: Enkapsulasi</h1>

    <div id="app-root" class="w-full max-w-2xl flex flex-col items-center">
        <!-- Konten Kuis/Login akan dirender di sini -->
        <div id="quiz-container" class="w-full flex justify-center"></div>
    </div>

    <!-- Riwayat akan dirender di sini -->
    <div id="history-container" class="w-full max-w-2xl"></div>
    
    <!-- Modal akan dirender di sini -->
    <div id="modal-container"></div>
</body>
</html>
